<!DOCTYPE html>
<html>
  <head>
    <title>City Zoom</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Search -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-geosearch@3.6.1/dist/geosearch.css"
    />
    <script src="https://unpkg.com/leaflet-geosearch@3.6.1/dist/geosearch.umd.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        background: black;
        font-family: Arial, sans-serif;
      }
      #header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 45px;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px 20px;
        z-index: 1000;
      }
      #header h1 {
        color: white;
        margin: 0;
        font-size: 24px;
        font-weight: bold;
      }
      #header .tagline {
        color: #888;
        margin: 0;
        font-size: 14px;
        font-weight: normal;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
      }
      @media (max-width: 768px) {
        #header .tagline {
          display: none;
        }
      }
      #header .header-left {
        display: flex;
        align-items: center;
      }
      #copyButton {
        background: black;
        color: white;
        border: 2px solid white;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        transition: background 0.3s, border-color 0.3s;
      }
      #copyButton:hover {
        background: #333;
      }
      #copyButton:active {
        background: #000;
      }
      #copyButton.copied {
        background: #222;
      }
      #map1,
      #map2 {
        box-sizing: border-box;
        border: 10px solid black;
      }
      /* Styles for screens with width greater than height (landscape) */
      @media (min-aspect-ratio: 1/1) {
        #map1 {
          height: calc(100vh - 70px);
          width: 50%;
          float: left;
          border-right-width: 0;
          margin-top: 45px;
        }
        #map2 {
          height: calc(100vh - 70px);
          width: 50%;
          float: left;
          border-left-width: 10px;
          margin-top: 45px;
        }
      }
      /* Styles for screens with height greater than width (portrait) */
      @media (max-aspect-ratio: 1/1) {
        #map1 {
          height: calc((100vh - 70px) / 2);
          width: 100%;
          border-bottom-width: 0;
          margin-top: 45px;
        }
        #map2 {
          height: calc((100vh - 70px) / 2);
          width: 100%;
          border-top-width: 10px;
        }
      }
      #footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 25px;
        line-height: 25px;
        background: rgba(0, 0, 0, 0.9);
        padding: 5px 20px;
        text-align: center;
        z-index: 1000;
        font-size: 12px;
        color: #888;
      }
      #footer a {
        color: #888;
        text-decoration: none;
      }
      #footer a:hover {
        color: #aaa;
      }
      #footer b {
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <div class="header-left">
        <h1>City Zoom</h1>
      </div>
      <span class="tagline">Compare two locations with synchronized zoom levels.</span>
      <button id="copyButton" onclick="copyUrl()">Copy URL</button>
    </div>
    <div id="map1"></div>
    <div id="map2"></div>
    <script>
      function syncZoom(level) {
        map1.setZoom(level);
        map2.setZoom(level);
      }

      function syncMaps() {
        const center1 = map1.getCenter();
        const center2 = map2.getCenter();
        const zoom = map1.getZoom();

        const params = new URLSearchParams({
          zoom: zoom,
          lat1: center1.lat.toFixed(5),
          lon1: center1.lng.toFixed(5),
          lat2: center2.lat.toFixed(5),
          lon2: center2.lng.toFixed(5),
        });

        history.pushState(null, "", "?" + params.toString());
        dismissCopiedState();
      }

      function copyUrl() {
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(function() {
          const button = document.getElementById('copyButton');
          button.textContent = 'Copied!';
          button.classList.add('copied');
          if (copyTimeout) {
            clearTimeout(copyTimeout);
          }
          copyTimeout = setTimeout(function() {
            dismissCopiedState();
          }, 10000);
        }).catch(function(err) {
          console.error('Failed to copy URL:', err);
          alert('Failed to copy URL. Please copy manually: ' + url);
        });
      }

      function dismissCopiedState() {
        const button = document.getElementById('copyButton');
        if (button.classList.contains('copied')) {
          button.textContent = originalButtonText;
          button.classList.remove('copied');
          if (copyTimeout) {
            clearTimeout(copyTimeout);
            copyTimeout = null;
          }
        }
      }

      // Get initial center coordinates and zoom levels

      const urlParams = new URLSearchParams(window.location.search);

      const initialCenter1 =
        urlParams.has("lat1") && urlParams.has("lon1")
          ? [parseFloat(urlParams.get("lat1")), parseFloat(urlParams.get("lon1"))]
          : [42.9634, -85.6681]; // Grand Rapids, MI

      const initialCenter2 =
        urlParams.has("lat2") && urlParams.has("lon2")
          ? [parseFloat(urlParams.get("lat2")), parseFloat(urlParams.get("lon2"))]
          : [42.3314, -83.0458]; // Detroit, MI

      const initialZoom = urlParams.has("zoom") ? parseInt(urlParams.get("zoom")) : 13;

      // Initialize the maps

      var map1 = L.map("map1").setView(initialCenter1, initialZoom);
      var map2 = L.map("map2").setView(initialCenter2, initialZoom);

      L.control.scale().addTo(map1);
      L.control.scale().addTo(map2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map1);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map2);

      // Initialize the copy button

      let copyTimeout = null;
      const originalButtonText = 'Copy URL';

      // Enable search

      const { GeoSearchControl, OpenStreetMapProvider } = window.GeoSearch;
      const provider = new OpenStreetMapProvider();

      const searchControl1 = new GeoSearchControl({
        provider: provider,
        style: "bar",
        searchLabel: "Search for a location",
      });

      const searchControl2 = new GeoSearchControl({
        provider: provider,
        style: "bar",
        searchLabel: "Search for a location",
      });

      map1.addControl(searchControl1);
      map2.addControl(searchControl2);

      // Add event handlers

      let isZooming = false;

      map1.on("zoomend", function () {
        if (!isZooming) {
          isZooming = true;
          syncZoom(map1.getZoom());
          syncMaps();
          setTimeout(() => { isZooming = false; }, 100);
        }
      });

      map2.on("zoomend", function () {
        if (!isZooming) {
          isZooming = true;
          syncZoom(map2.getZoom());
          syncMaps();
          setTimeout(() => { isZooming = false; }, 100);
        }
      });

      map1.on("moveend", syncMaps);
      map2.on("moveend", syncMaps);

      map1.on("geosearch/showlocation", function (e) {
        map1.setView(e.location, 13);
      });

      map2.on("geosearch/showlocation", function (e) {
        map2.setView(e.location, 13);
      });
    </script>
    <div id="footer">
      <a href="https://cityzoom.link"><b>City Zoom</b></a> is an <a href="https://github.com/citizenlabsgr/cityzoom" target="_blank"><b>open source</b></a> project by <a href="https://citizenlabs.org/" target="_blank"><b>Citizen Labs</b></a>.
    </div>
  </body>
</html>
